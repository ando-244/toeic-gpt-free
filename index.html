<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TOEIC GPT Free Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    header {
      background: #1f2937;
      color: #fff;
      padding: 0.5rem 1rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    main {
      display: grid;
      grid-template-columns: minmax(260px, 320px) 1fr;
      gap: 1rem;
      padding: 1rem;
    }
    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    section {
      background: #fff;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    h2 {
      margin-top: 0;
      font-size: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.3rem;
      margin-bottom: 0.5rem;
    }
    .field-group {
      margin-bottom: 0.5rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }
    select, button, input[type="text"] {
      font: inherit;
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }
    select {
      width: 100%;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: default;
    }
    #itemList {
      height: 260px;
      font-size: 0.85rem;
    }
    #status {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #6b7280;
      min-height: 1em;
    }
    #previewTitle {
      font-size: 1rem;
      margin: 0 0 0.25rem 0;
    }
    #previewMeta {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    #previewStem {
      font-size: 0.9rem;
      background: #f9fafb;
      padding: 0.5rem;
      border-radius: 4px;
      white-space: pre-wrap;
      margin-bottom: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    #audioArea {
      margin-bottom: 0.75rem;
    }
    #audioPlayer {
      width: 100%;
      max-width: 480px;
    }
    #audioLinks a, #pageLink a, #imageLink a {
      font-size: 0.85rem;
      color: #2563eb;
      text-decoration: none;
      margin-right: 0.5rem;
    }
    #audioLinks a:hover, #pageLink a:hover, #imageLink a:hover {
      text-decoration: underline;
    }
    #imagePreview {
      max-width: 240px;
      max-height: 160px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      object-fit: cover;
      display: none;
      margin-top: 0.25rem;
    }
    #rawJson {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      background: #f9fafb;
      border-radius: 4px;
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      max-height: 260px;
      overflow: auto;
      white-space: pre;
    }
  </style>
</head>
<body>
  <header>
    <h1>TOEIC GPT Free &middot; プレイヤー</h1>
  </header>

  <main>
    <!-- 左: リスト & フィルタ -->
    <section aria-label="問題一覧とフィルター">
      <h2>問題一覧</h2>

      <div class="field-group">
        <button id="btnLoadManifest" type="button">
          JSON一覧を読み込み（manifest）
        </button>
      </div>

      <div class="field-group" style="display:flex; gap:0.5rem;">
        <div style="flex:1;">
          <label for="partFilter">Part フィルター</label>
          <select id="partFilter" name="partFilter">
            <option value="">すべて</option>
            <option value="1">Part 1</option>
            <option value="2">Part 2</option>
            <option value="3">Part 3</option>
            <option value="4">Part 4</option>
          </select>
        </div>
        <div style="flex:1;">
          <label for="levelFilter">Level フィルター</label>
          <select id="levelFilter" name="levelFilter">
            <option value="">すべて</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label for="itemList">JSON の一覧</label>
        <select id="itemList" name="itemList" size="12" aria-label="JSONの一覧から1件を選択してください">
          <!-- manifest.json 読み込み後に埋められる -->
        </select>
      </div>

      <div class="field-group">
        <button id="btnLoadItem" type="button">
          選択した JSON を読み込み
        </button>
      </div>

      <div id="status" aria-live="polite"></div>
    </section>

    <!-- 右: プレビュー -->
    <section aria-label="問題プレビューと音声再生">
      <h2>プレビュー &amp; Audio</h2>

      <h3 id="previewTitle">問題未選択</h3>
      <div id="previewMeta"></div>
      <div id="previewStem"></div>

      <div id="audioArea">
        <audio id="audioPlayer" controls preload="none">
          お使いのブラウザは audio 要素に対応していません。
        </audio>
        <div id="audioLinks"></div>
      </div>

      <div id="pageLink"></div>

      <div class="field-group">
        <div id="imageLink"></div>
        <img id="imagePreview" alt="問題に紐づく画像プレビュー" />
      </div>

      <h3 style="margin-top:0.75rem; font-size:0.9rem;">生 JSON</h3>
      <pre id="rawJson">ここに JSON の中身が表示されます。</pre>
    </section>
  </main>

  <script>
    // manifest.json の内容を保持するグローバル
    let manifestItems = [];

    const statusEl       = document.getElementById("status");
    const partFilterEl   = document.getElementById("partFilter");
    const levelFilterEl  = document.getElementById("levelFilter");
    const itemListEl     = document.getElementById("itemList");
    const btnLoadManifest = document.getElementById("btnLoadManifest");
    const btnLoadItem    = document.getElementById("btnLoadItem");

    const previewTitleEl = document.getElementById("previewTitle");
    const previewMetaEl  = document.getElementById("previewMeta");
    const previewStemEl  = document.getElementById("previewStem");
    const rawJsonEl      = document.getElementById("rawJson");

    const audioPlayer    = document.getElementById("audioPlayer");
    const audioLinksEl   = document.getElementById("audioLinks");
    const pageLinkEl     = document.getElementById("pageLink");
    const imagePreview   = document.getElementById("imagePreview");
    const imageLinkEl    = document.getElementById("imageLink");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    // manifest.json を読み込む
    async function loadManifest() {
      try {
        setStatus("manifest.json を読み込み中...");
        btnLoadManifest.disabled = true;

        // index.html と同じリポジトリ内の public/manifest.json を読む
        const res = await fetch("public/manifest.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        const items = Array.isArray(data) ? manifest : data.items;

        if (!Array.isArray(items)) {
          throw new Error("manifest.json が配列ではありません");
        }

        manifestItems = items;
        renderItemList();
        setStatus("manifest.json を読み込みました。件数: " + manifestItems.length);
      } catch (e) {
        console.error(e);
        setStatus("manifest 読み込みに失敗: " + e.message);
      } finally {
        btnLoadManifest.disabled = false;
      }
    }

    // フィルタをかけて一覧を描画
    function renderItemList() {
      const partVal  = partFilterEl.value;
      const levelVal = levelFilterEl.value;

      const filtered = manifestItems.filter(item => {
        if (partVal && String(item.part) !== partVal) return false;
        if (levelVal && String(item.level) !== levelVal) return false;
        return true;
      });

      itemListEl.innerHTML = "";
      filtered.forEach((item, idx) => {
        const opt = document.createElement("option");
        // 表示ラベル: "p3-20251106-0001-1 (P3 / A2)"
        const partLabel  = item.part ? "P" + item.part : "?";
        const levelLabel = item.level || "?";
        opt.textContent = (item.id || "item-" + idx) + " (" + partLabel + " / " + levelLabel + ")";
        // value として json_path を持たせる
        opt.value = item.json_path || "";
        // 念のため id も data 属性で保持
        opt.dataset.itemId = item.id || "";
        itemListEl.appendChild(opt);
      });

      if (filtered.length === 0) {
        setStatus("フィルタ条件に一致する項目がありません。");
      } else {
        setStatus("一覧更新: " + filtered.length + " 件");
      }
    }

    // 1件の JSON を読み込んで右側に反映
    async function loadItemFromSelection() {
      const selected = itemListEl.value;
      if (!selected) {
        alert("読み込む JSON を一覧から選択してください。");
        return;
      }

      const jsonPath = selected; // "items/part3/..." を想定
      setStatus("JSON 読み込み中: " + jsonPath);
      btnLoadItem.disabled = true;

      try {
        const res = await fetch(jsonPath, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("JSON load failed: " + res.status);
        }
        const data = await res.json();
        displayItem(data, jsonPath);
        setStatus("JSON 読み込み完了: " + (data.id || jsonPath));
      } catch (e) {
        console.error(e);
        setStatus("JSON 読み込みエラー: " + e.message);
      } finally {
        btnLoadItem.disabled = false;
      }
    }

    // JSON を UI に反映
    function displayItem(item, jsonPath) {
      const id    = item.id || "(idなし)";
      const part  = item.part != null ? "Part " + item.part : "(part不明)";
      const level = item.level || "(level不明)";

      previewTitleEl.textContent = id;
      previewMetaEl.textContent  = part + " / " + level + " / " + jsonPath;

      const stem = item.content && item.content.stem ? item.content.stem : "";
      previewStemEl.textContent = stem;

      // 生 JSON 表示
      rawJsonEl.textContent = JSON.stringify(item, null, 2);

      const assets = item.assets || {};
      const audioUrl = assets.audio_url || "";
      const imageUrl = assets.image_url || "";
      const pageUrl  = assets.page_url || "";

      // Audio 設定
      audioPlayer.src = audioUrl || "";
      audioPlayer.load();

      audioLinksEl.innerHTML = "";
      if (audioUrl) {
        const a = document.createElement("a");
        a.href = audioUrl;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "audio_url を別タブで開く";
        audioLinksEl.appendChild(a);
      }

      // page_url リンク
      pageLinkEl.innerHTML = "";
      if (pageUrl) {
        const a = document.createElement("a");
        a.href = pageUrl;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "page_url（設問ページ）を開く";
        pageLinkEl.appendChild(a);
      }

      // 画像
      imageLinkEl.innerHTML = "";
      if (imageUrl) {
        imagePreview.style.display = "block";
        imagePreview.src = imageUrl;

        const a = document.createElement("a");
        a.href = imageUrl;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "image_url を別タブで開く";
        imageLinkEl.appendChild(a);
      } else {
        imagePreview.style.display = "none";
        imagePreview.src = "";
      }
    }

    // イベント設定
    btnLoadManifest.addEventListener("click", loadManifest);
    btnLoadItem.addEventListener("click", loadItemFromSelection);
    partFilterEl.addEventListener("change", renderItemList);
    levelFilterEl.addEventListener("change", renderItemList);

    // ページ初期表示時はステータスメッセージだけ
    setStatus("まず「JSON一覧を読み込み（manifest）」をクリックしてください。");
  </script>
</body>
</html>