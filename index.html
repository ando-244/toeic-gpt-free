<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TOEIC Items Player</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
  header { padding: 12px 16px; border-bottom: 1px solid #2b2f36; }
  main { display: grid; grid-template-columns: 320px 1fr; gap: 0; min-height: calc(100vh - 60px); }
  aside { border-right: 1px solid #2b2f36; padding: 12px; }
  section { padding: 16px; }
  select, input[type=text], button { width: 100%; padding: 8px; margin: 6px 0; background: #14161b; color: #eaf0f1; border: 1px solid #2b2f36; border-radius: 8px; }
  .card { background: #14161b; border: 1px solid #2b2f36; border-radius: 12px; padding: 16px; margin: 12px 0; }
  audio, img { width: 100%; border-radius: 8px; }
  pre { white-space: pre-wrap; word-break: break-all; background: #0f1115; border: 1px solid #2b2f36; padding: 12px; border-radius: 8px; max-height: 240px; overflow: auto;}
  small { color: #9fb3c8; }
  .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  button:disabled { opacity: .5; cursor: not-allowed; }
  button:not(:disabled):active { transform: translateY(1px); }
</style>

<header>
  <h1 style="margin:0;">TOEIC Items Player</h1>
  <small>Repository: ando-244/toeic-gpt-free</small>
</header>

<main>
  <aside>
    <div class="card">
      <div><b>1) 探すフォルダ</b></div>
      <select id="folder">
        <option value="items/part1">items/part1</option>
        <option value="items/part2">items/part2</option>
        <option value="items/part3">items/part3</option>
        <option value="items/part4">items/part4</option>
      </select>
      <button id="scan">GitHub APIでJSONを列挙</button>
      <small>最新月が下層にある想定です</small>
    </div>

    <div class="card">
      <div><b>2) JSON を選択</b></div>
      <select id="jsonList" size="12" style="height:300px;"></select>
      <button id="btnload" type="button" disabled>読み込み</button>
    </div>

    <div class="card">
      <div><b>URL直指定</b></div>
      <input id="directUrl" type="text" placeholder="https://.../items/part3/yyyy/mm/file.json">
      <button id="loadDirect">読み込み</button>
      <small>クロスオリジン可。CORS は GitHub API と Pages で許可されています。</small>
    </div>
  </aside>

  <section>
    <div class="card">
      <div class="row">
        <b>Audio</b>
        <small id="mimeInfo"></small>
      </div>
      <audio id="player" controls preload="auto" playsinline crossorigin="anonymous">
        すみません。お使いのブラウザでは再生できません。
      </audio>
    </div>

    <div class="card">
      <b>Image</b>
      <img id="pic" alt="" referrerpolicy="no-referrer">
    </div>

    <div class="card">
      <b>JSON</b>
      <pre id="jsonView"></pre>
    </div>
  </section>
</main>

<script>
const BASE = "https://ando-244.github.io/toeic-gpt-free";
const REPO = "ando-244/toeic-gpt-free";
const BRANCH = "main";
const RAW = "https://raw.githubusercontent.com/ando-244/toeic-gpt-free/main";

async function listJsonUnder(pathPrefix) {
  // 例: pathPrefix = "items/part3"
  const treeUrl = `https://api.github.com/repos/${REPO}/git/trees/${encodeURIComponent(BRANCH)}?recursive=1`;
  const headers = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28"
  };

  const res = await fetch(treeUrl + `&_=${Date.now()}`, {
    headers,
    cache: "no-store" // 任意。無くてもOK（タイムスタンプで回避済み）
  });
  if (!res.ok) {
    throw new Error(`GitHub API error: HTTP ${res.status}`);
  }
  const data = await res.json();
  if (!data || !Array.isArray(data.tree)) {
    throw new Error("Unexpected response shape for git/trees");
  }

  // ツリーから目的の JSON を抽出
  // 期待パス: items/partX/YYYY/MM/xxx.json
  const re = new RegExp(`^${pathPrefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}/\\d{4}/\\d{2}/.+\\.json$`);
  // 新しい順で見せたいので降順ソート
  const files = data.tree
    .filter(n => n.type === "blob" && re.test(n.path))
    .map(n => n.path)
    .sort((a, b) => b.localeCompare(a))
    .slice(0, 200);

  return files;
}

function setLoadEnabled(on) {
  const btn = document.getElementById("btnload");
  btn.disabled = !on;
  if (on) btn.removeAttribute("disabled");
  else btn.setAttribute("disabled", "");
}

function setAudioSources(url) {
  const player = document.getElementById("player");
  // 絶対/相対どちらでもOKにする
  const finalUrl = new URL(url, BASE).href;
  player.src = finalUrl;
  player.load();
  document.getElementById("mimeInfo").textContent = finalUrl;
}

async function loadItem(jsonUrl) {
  let url;
  if (/^https?:\/\//i.test(jsonUrl)) {
    // 絶対URLはそのまま
    url = jsonUrl;
  } else {
    // リポジトリ相対パスは RAW から取得（APIと同じ内容を確実に読む）
    url = `${RAW}/${jsonUrl.replace(/^\.?\//, "")}`;
  }

  const res = await fetch(url, { headers: { "Accept": "application/json" }});
  if (!res.ok) throw new Error("JSON load failed: " + res.status);
  const data = await res.json();
  document.getElementById("jsonView").textContent = JSON.stringify(data, null, 2);

  // 音声は JSON 内の URL をそのまま使う（Pages 上の mp3 を指している想定）
  const audio = data.assets?.audio_url;
  if (audio) {
    setAudioSources(audio);
    // リンクをクリックで新規タブ確認できるように
    const info = document.getElementById("mimeInfo");
    info.innerHTML = `<a href="${new URL(audio, BASE).href}" target="_blank" rel="noopener">audio_url を開く</a>`;
  } else {
    document.getElementById("mimeInfo").textContent = "no audio_url";
  }

  const img = data.assets?.image_url;
  const pic = document.getElementById("pic");
  if (img) {
    pic.src = new URL(img, BASE).href;
    pic.style.display = "";
  } else {
    pic.removeAttribute("src");
    pic.style.display = "none";
  }
}

document.getElementById("scan").addEventListener("click", async () => {
  const folder = document.getElementById("folder").value;
  const list = document.getElementById("jsonList");
  list.innerHTML = "<option>読み込み中...</option>";
  setLoadEnabled(false);

  try {
    const files = await listJsonUnder(folder);

    list.innerHTML = "";
    if (!files.length) {
      list.innerHTML = "<option>該当するJSONが見つかりません</option>";
      return;
    }
    for (const p of files) {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      list.appendChild(opt);
    }

    list.selectedIndex = 0;
    setLoadEnabled(true);
    list.focus();
  } catch (e) {
    console.error(e);
    const msg = (e && e.message) ? e.message : "不明なエラー";
    list.innerHTML = `<option>取得に失敗: ${msg}</option>`;
    setLoadEnabled(false);
    if (/rate limit/i.test(msg)) {
      alert("GitHub APIのレート制限に達しました。少し時間をあけるか、月別フォルダを減らしてください。");
    }
  }
});

// ② JSONリスト選択で「読み込み」を活性化
const jsonListEl = document.getElementById("jsonList");
function onJsonListChange() {
  setLoadEnabled(!!jsonListEl.value);
}
jsonListEl.addEventListener("change", onJsonListChange);
jsonListEl.addEventListener("input", onJsonListChange);
jsonListEl.addEventListener("click", onJsonListChange);

// ③ 「読み込み」ボタン
document.getElementById("btnload").addEventListener("click", async (ev) => {
  const btn = ev.currentTarget;
  const sel = document.getElementById("jsonList");
  const opt = sel.selectedOptions[0];
  if (!opt) return;

  btn.textContent = "読み込み中…";
  btn.disabled = true;

  try {
    // 1) JSON を読み込み、audio.src を設定
    await loadItem(opt.value);
    const player = document.getElementById("player");

    // 2) canplay を待ってから再生（最大2秒待ち）
    await Promise.race([
      new Promise(res => {
        const onCanPlay = () => {
          player.removeEventListener("canplay", onCanPlay);
          res();
        };
        player.addEventListener("canplay", onCanPlay, { once: true });
        // 念のため明示ロード
        try { player.load(); } catch {}
      }),
      new Promise(res => setTimeout(res, 2000))
    ]);

    // 3) 再生（失敗しても UI は前進させる）
    await player.play().catch(e => console.debug("autoplay blocked:", e));
  } catch (e) {
    console.error(e);
    alert("読み込みに失敗しました。Console を確認してください。");
  } finally {
    btn.textContent = "読み込み";
    setLoadEnabled(!!document.getElementById("jsonList").value);
  }
});

// ④ URL直指定の読み込み
document.getElementById("loadDirect").addEventListener("click", async (ev) => {
  const btn = ev.currentTarget;
  const u = document.getElementById("directUrl").value.trim();
  if (!u) return;

  btn.textContent = "読み込み中…";
  btn.disabled = true;

  try {
    await loadItem(u);
    const player = document.getElementById("player");
    await player.play().catch(e => console.debug("autoplay blocked:", e));
  } catch (e) {
    console.error(e);
    alert("読み込みに失敗しました。URLをご確認ください。");
  } finally {
    btn.textContent = "読み込み";
    btn.disabled = false;
  }
});
</script>
